{"version":3,"sources":["../../src/utils/cache.js"],"names":["Promise","require","low","fs","_","db","directory","exports","initCache","ensureDirSync","process","cwd","env","NODE_ENV","tmpdir","format","serialize","JSON","stringify","obj","deserialize","parse","str","mixin","previousState","readFileSync","e","defaults","write","keys","get","resolve","reject","pair","getById","key","value","set","upsert","id","save","debounce","writeFile","getState","noop"],"mappings":";;AAAA,IAAMA,UAAUC,QAAS,UAAT,CAAhB;AACA,IAAMC,MAAMD,QAAS,OAAT,CAAZ;AACA,IAAME,KAAKF,QAAS,UAAT,CAAX;AACA,IAAMG,IAAIH,QAAS,QAAT,CAAV;;AAEA,IAAII,WAAJ;AACA,IAAIC,kBAAJ;;AAEA;;;AAGAC,QAAQC,SAAR,GAAoB,YAAM;AACxBL,KAAGM,aAAH,CAAkB,GAAEC,QAAQC,GAAR,EAAc,eAAlC;AACA,MAAID,QAAQE,GAAR,CAAYC,QAAZ,KAA0B,MAA9B,EAAqC;AACnCP,gBAAYL,QAAS,IAAT,EAAca,MAAd,EAAZ;AACD,GAFD,MAEO;AACLR,gBAAYI,QAAQC,GAAR,KAAiB,eAA7B;AACD;AACDN,OAAKH,IAAI,IAAJ,EAAU;AACba,YAAQ;AACNC,iBAAW;AAAA,eAAOC,KAAKC,SAAL,CAAeC,GAAf,CAAP;AAAA,OADL;AAENC,mBAAa;AAAA,eAAOH,KAAKI,KAAL,CAAWC,GAAX,CAAP;AAAA;AAFP;AADK,GAAV,CAAL;AAMAjB,KAAGD,CAAH,CAAKmB,KAAL,CAAWtB,QAAS,WAAT,CAAX;;AAEA,MAAIuB,sBAAJ;AACA,MAAI;AACFA,oBAAgBP,KAAKI,KAAL,CAAWlB,GAAGsB,YAAH,CAAiB,GAAEnB,SAAU,UAA7B,CAAX,CAAhB;AACD,GAFD,CAEE,OAAOoB,CAAP,EAAU;AACV;AACD;;AAED,MAAIF,aAAJ,EAAmB;AACjBnB,OAAGsB,QAAH,CAAYH,aAAZ,EAA2BI,KAA3B;AACD,GAFD,MAEO;AACLvB,OAAGsB,QAAH,CAAY,EAAEE,MAAM,EAAR,EAAZ,EAA0BD,KAA1B;AACD;AACF,CA3BD;;AA6BA;;;;;AAKArB,QAAQuB,GAAR,GAAc;AAAA,SACZ,IAAI9B,OAAJ,CAAY,UAAC+B,OAAD,EAAUC,MAAV,EAAqB;AAC/B,QAAIC,aAAJ;AACA,QAAI;AACFA,aAAO5B,GACJyB,GADI,CACC,MADD,EAEJI,OAFI,CAEIC,GAFJ,EAGJC,KAHI,EAAP;AAID,KALD,CAKE,OAAOV,CAAP,EAAU;AACV;AACD;;AAED,QAAIO,IAAJ,EAAU;AACRF,cAAQE,KAAKG,KAAb;AACD,KAFD,MAEO;AACLL;AACD;AACF,GAhBD,CADY;AAAA,CAAd;;AAmBA;;;;;;AAMAxB,QAAQ8B,GAAR,GAAc,UAACF,GAAD,EAAMC,KAAN;AAAA,SACZ,IAAIpC,OAAJ,CAAY,UAAC+B,OAAD,EAAUC,MAAV,EAAqB;AAC/B3B,OACGyB,GADH,CACQ,MADR,EAEGQ,MAFH,CAEU,EAAEC,IAAIJ,GAAN,EAAWC,KAAX,EAFV,EAGGR,KAHH;AAIAY;AACAT,YAAS,IAAT;AACD,GAPD,CADY;AAAA,CAAd;;AAUA,IAAIS,aAAJ;;AAEA,IAAI9B,QAAQE,GAAR,CAAYC,QAAZ,KAA0B,MAA9B,EAAqC;AACnC2B,SAAOpC,EAAEqC,QAAF,CAAW,YAAM;AACtBtC,OAAGuC,SAAH,CAAc,GAAEpC,SAAU,UAA1B,EAAqCW,KAAKC,SAAL,CAAeb,GAAGsC,QAAH,EAAf,CAArC;AACD,GAFM,EAEJ,GAFI,CAAP;AAGD,CAJD,MAIO;AACLH,SAAOpC,EAAEwC,IAAT;AACD","file":"cache.js","sourcesContent":["const Promise = require(`bluebird`)\nconst low = require(`lowdb`)\nconst fs = require(`fs-extra`)\nconst _ = require(`lodash`)\n\nlet db\nlet directory\n\n/**\n * Initialize cache store. Reuse existing store if available.\n */\nexports.initCache = () => {\n  fs.ensureDirSync(`${process.cwd()}/.cache/cache`)\n  if (process.env.NODE_ENV === `test`) {\n    directory = require(`os`).tmpdir()\n  } else {\n    directory = process.cwd() + `/.cache/cache`\n  }\n  db = low(null, {\n    format: {\n      serialize: obj => JSON.stringify(obj),\n      deserialize: str => JSON.parse(str),\n    },\n  })\n  db._.mixin(require(`lodash-id`))\n\n  let previousState\n  try {\n    previousState = JSON.parse(fs.readFileSync(`${directory}/db.json`))\n  } catch (e) {\n    // ignore\n  }\n\n  if (previousState) {\n    db.defaults(previousState).write()\n  } else {\n    db.defaults({ keys: [] }).write()\n  }\n}\n\n/**\n * Get value of key\n * @param key\n * @returns {Promise}\n */\nexports.get = key =>\n  new Promise((resolve, reject) => {\n    let pair\n    try {\n      pair = db\n        .get(`keys`)\n        .getById(key)\n        .value()\n    } catch (e) {\n      // ignore\n    }\n\n    if (pair) {\n      resolve(pair.value)\n    } else {\n      resolve()\n    }\n  })\n\n/**\n * Create or update key with value\n * @param key\n * @param value\n * @returns {Promise} - Promise object which resolves to 'Ok' if successful.\n */\nexports.set = (key, value) =>\n  new Promise((resolve, reject) => {\n    db\n      .get(`keys`)\n      .upsert({ id: key, value })\n      .write()\n    save()\n    resolve(`Ok`)\n  })\n\nlet save\n\nif (process.env.NODE_ENV !== `test`) {\n  save = _.debounce(() => {\n    fs.writeFile(`${directory}/db.json`, JSON.stringify(db.getState()))\n  }, 250)\n} else {\n  save = _.noop\n}\n"]}