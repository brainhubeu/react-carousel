{"version":3,"sources":["../../../src/internal-plugins/query-runner/query-runner.js"],"names":["fs","require","report","md5","joinPath","store","resultHashes","indentString","string","replace","module","exports","pageOrLayout","component","id","_id","getState","schema","program","graphql","query","context","result","errors","log","componentPath","path","JSON","stringify","pluginCreatorId","_name","process","exit","contextKey","resultJSON","resultHash","resultPath","directory","jsonName","writeFile"],"mappings":";;;;;;;;;;;;;;AAAA;;;;AACA,IAAMA,KAAKC,QAAS,UAAT,CAAX;AACA,IAAMC,SAASD,QAAS,yBAAT,CAAf;AACA,IAAME,MAAMF,QAAS,KAAT,CAAZ;;eAEqBA,QAAS,kBAAT,C;IAAbG,Q,YAAAA,Q;;gBACUH,QAAS,aAAT,C;IAAVI,K,aAAAA,K;;AAER,IAAMC,eAAe,EAArB;;AAEA,IAAMC,eAAe,SAAfA,YAAe;AAAA,SAAUC,OAAOC,OAAP,CAAe,KAAf,EAAuB,MAAvB,CAAV;AAAA,CAArB;;AAEA;AACAC,OAAOC,OAAP;AAAA,sFAAiB,iBAAOC,YAAP,EAAqBC,SAArB;AAAA;;AAAA;AAAA;AAAA;AAAA;AACfD,yBAAaE,EAAb,GAAkBF,aAAaG,GAA/B;AADe,8BAEaV,MAAMW,QAAN,EAFb,EAEPC,MAFO,mBAEPA,MAFO,EAECC,OAFD,mBAECA,OAFD;;AAITC,mBAJS,GAIC,SAAVA,OAAU,CAACC,KAAD,EAAQC,OAAR;AAAA,qBACd,sBAAgBJ,MAAhB,EAAwBG,KAAxB,EAA+BC,OAA/B,EAAwCA,OAAxC,EAAiDA,OAAjD,CADc;AAAA,aAJD;;AAOf;;;AACIC,kBARW;;AAUf;;AAVe,kBAWX,CAACT,UAAUO,KAAX,IAAoBP,UAAUO,KAAV,KAAqB,EAX9B;AAAA;AAAA;AAAA;;AAYbE,qBAAS,EAAT;AAZa;AAAA;;AAAA;AAAA;AAAA,mBAcEH,QAAQN,UAAUO,KAAlB,6BACVR,YADU,EAEVA,aAAaS,OAFH,EAdF;;AAAA;AAcbC,kBAda;;AAAA;;AAoBf;AACA;AACA,gBAAIA,UAAUA,OAAOC,MAArB,EAA6B;AAC3BrB,qBAAOsB,GAAP,CAAY;yBACSX,UAAUY,aAAc;;;IAG7CH,OAAOC,MAAP,IAAiB,EAAG;;IAEpBX,aAAac,IAAK;;IAElBnB,aAAaoB,KAAKC,SAAL,CAAehB,aAAaS,OAA5B,EAAqC,IAArC,EAA2C,CAA3C,CAAb,CAA4D;;IAE5DT,aAAaiB,eAAb,IAAiC,MAAM;;IAEvCtB,aAAaM,UAAUO,KAAvB,CAA8B,EAZ9B;;AAcA;AACA,kBAAIF,QAAQY,KAAR,KAAmB,OAAvB,EAA+B;AAC7BC,wBAAQC,IAAR,CAAa,CAAb;AACD;AACF;;AAED;AACIC,sBA5CW,GA4CG,aA5CH;;AA6Cf,gBAAI,CAACrB,aAAac,IAAlB,EAAwB;AACtBO,2BAAc,eAAd;AACD;AACDX,mBAAOW,UAAP,IAAqBrB,aAAaS,OAAlC;AACMa,sBAjDS,GAiDIP,KAAKC,SAAL,CAAeN,MAAf,CAjDJ;AAkDTa,sBAlDS,GAkDIhC,IAAI+B,UAAJ,CAlDJ;AAmDTE,sBAnDS,GAmDIhC,SACjBc,QAAQmB,SADS,EAEhB,QAFgB,EAGhB,MAHgB,EAIjBzB,aAAa0B,QAJI,CAnDJ;;AAAA,kBA0DXhC,aAAa8B,UAAb,MAA6BD,UA1DlB;AAAA;AAAA;AAAA;;AA2Db7B,yBAAa8B,UAAb,IAA2BD,UAA3B;AA3Da;AAAA,mBA4DPnC,GAAGuC,SAAH,CAAaH,UAAb,EAAyBF,UAAzB,CA5DO;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,GAAjB;;AAAA;AAAA;AAAA;AAAA","file":"query-runner.js","sourcesContent":["import { graphql as graphqlFunction } from \"graphql\"\nconst fs = require(`fs-extra`)\nconst report = require(`gatsby-cli/lib/reporter`)\nconst md5 = require(`md5`)\n\nconst { joinPath } = require(`../../utils/path`)\nconst { store } = require(`../../redux`)\n\nconst resultHashes = {}\n\nconst indentString = string => string.replace(/\\n/g, `\\n  `)\n\n// Run query for a page\nmodule.exports = async (pageOrLayout, component) => {\n  pageOrLayout.id = pageOrLayout._id\n  const { schema, program } = store.getState()\n\n  const graphql = (query, context) =>\n    graphqlFunction(schema, query, context, context, context)\n\n  // Run query\n  let result\n\n  // Nothing to do if the query doesn't exist.\n  if (!component.query || component.query === ``) {\n    result = {}\n  } else {\n    result = await graphql(component.query, {\n      ...pageOrLayout,\n      ...pageOrLayout.context,\n    })\n  }\n\n  // If there's a graphql error then log the error. If we're building, also\n  // quit.\n  if (result && result.errors) {\n    report.log(`\nThe GraphQL query from ${component.componentPath} failed.\n\nErrors:\n  ${result.errors || []}\nURL path:\n  ${pageOrLayout.path}\nContext:\n  ${indentString(JSON.stringify(pageOrLayout.context, null, 2))}\nPlugin:\n  ${pageOrLayout.pluginCreatorId || `none`}\nQuery:\n  ${indentString(component.query)}`)\n\n    // Perhaps this isn't the best way to see if we're building?\n    if (program._name === `build`) {\n      process.exit(1)\n    }\n  }\n\n  // Add the path/layout context onto the results.\n  let contextKey = `pathContext`\n  if (!pageOrLayout.path) {\n    contextKey = `layoutContext`\n  }\n  result[contextKey] = pageOrLayout.context\n  const resultJSON = JSON.stringify(result)\n  const resultHash = md5(resultJSON)\n  const resultPath = joinPath(\n    program.directory,\n    `.cache`,\n    `json`,\n    pageOrLayout.jsonName\n  )\n\n  if (resultHashes[resultPath] !== resultHash) {\n    resultHashes[resultPath] = resultHash\n    await fs.writeFile(resultPath, resultJSON)\n  }\n}\n"]}