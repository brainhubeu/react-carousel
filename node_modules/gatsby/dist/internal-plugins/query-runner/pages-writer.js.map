{"version":3,"sources":["../../../src/internal-plugins/query-runner/pages-writer.js"],"names":["_","require","fs","store","emitter","getLayoutById","layouts","find","l","id","writePages","bootstrapFinished","getState","program","pages","pagesData","reduce","mem","path","matchPath","componentChunkName","layout","jsonName","layoutOjb","machineId","layoutComponentChunkName","components","json","pageLayouts","forEach","push","p","component","Error","includes","uniq","uniqBy","c","syncRequires","map","componentWrapperPath","join","j","directory","asyncRequires","writeAndMove","file","data","destination","tmp","Date","now","writeFile","then","move","overwrite","Promise","all","JSON","stringify","exports","oldPages","debouncedWritePages","debounce","isEqual","leading","on"],"mappings":"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","file":"pages-writer.js","sourcesContent":["const _ = require(`lodash`)\nconst fs = require(`fs-extra`)\n\nconst { store, emitter } = require(`../../redux/`)\nimport { generatePathChunkName } from \"../../utils/js-chunk-names\"\n\nimport { joinPath } from \"../../utils/path\"\n\nconst getLayoutById = layouts => id => layouts.find(l => l.id === id)\n\n// Write out pages information.\nconst writePages = async () => {\n  bootstrapFinished = true\n  let { program, pages, layouts } = store.getState()\n  // Write out pages.json\n  const pagesData = pages.reduce(\n    (mem, { path, matchPath, componentChunkName, layout, jsonName }) => {\n      const layoutOjb = getLayoutById(layouts)(layout)\n      return [\n        ...mem,\n        {\n          componentChunkName,\n          layout: layoutOjb ? layoutOjb.machineId : layout,\n          layoutComponentChunkName: layoutOjb && layoutOjb.componentChunkName,\n          jsonName,\n          path,\n          matchPath,\n        },\n      ]\n    },\n    []\n  )\n\n  // Get list of components, layouts, and json files.\n  let components = []\n  let json = []\n  let pageLayouts = []\n\n  pages.forEach(p => {\n    components.push({\n      componentChunkName: p.componentChunkName,\n      component: p.component,\n    })\n    if (p.layout) {\n      let layout = getLayoutById(layouts)(p.layout)\n\n      if (!layout) {\n        throw new Error(\n          `Could not find layout '${\n            p.layout\n          }'. Check if this file exists in 'src/layouts'.`\n        )\n      }\n\n      if (!_.includes(pageLayouts, layout)) {\n        pageLayouts.push(layout)\n        json.push({\n          jsonName: layout.jsonName,\n        })\n      }\n    }\n    json.push({ path: p.path, jsonName: p.jsonName })\n  })\n\n  pageLayouts = _.uniq(pageLayouts)\n  components = _.uniqBy(components, c => c.componentChunkName)\n\n  // Create file with sync requires of layouts/components/json files.\n  let syncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.layouts = {\\n${pageLayouts\n    .map(\n      l =>\n        `  \"${l.machineId}\": preferDefault(require(\"${\n          l.componentWrapperPath\n        }\"))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": preferDefault(require(\"${joinPath(\n          c.component\n        )}\"))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  syncRequires += `exports.json = {\\n${json\n    .map(\n      j =>\n        `  \"${j.jsonName}\": require(\"${joinPath(\n          program.directory,\n          `/.cache/json/`,\n          j.jsonName\n        )}\")`\n    )\n    .join(`,\\n`)}\n}`\n\n  // Create file with async requires of layouts/components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": require(\"gatsby-module-loader?name=${\n          c.componentChunkName\n        }!${joinPath(c.component)}\")`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  asyncRequires += `exports.json = {\\n${json\n    .map(\n      j =>\n        `  \"${\n          j.jsonName\n        }\": require(\"gatsby-module-loader?name=${generatePathChunkName(\n          j.path\n        )}!${joinPath(program.directory, `/.cache/json/`, j.jsonName)}\")`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n  asyncRequires += `exports.layouts = {\\n${pageLayouts\n    .map(\n      l =>\n        `  \"${l.machineId}\": require(\"gatsby-module-loader?name=${\n          l.componentChunkName\n        }!${l.componentWrapperPath}\")`\n    )\n    .join(`,\\n`)}\n}`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  return await Promise.all([\n    writeAndMove(`pages.json`, JSON.stringify(pagesData, null, 4)),\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n  ])\n}\n\nexports.writePages = writePages\n\nlet bootstrapFinished = false\nlet oldPages\nconst debouncedWritePages = _.debounce(\n  () => {\n    // Don't write pages again until bootstrap has finished.\n    if (bootstrapFinished && !_.isEqual(oldPages, store.getState().pages)) {\n      writePages()\n      oldPages = store.getState().pages\n    }\n  },\n  500,\n  { leading: true }\n)\nemitter.on(`CREATE_PAGE`, () => {\n  // Ignore CREATE_PAGE until bootstrap is finished\n  // as this is called many many times during bootstrap and\n  // we can ignore them until CREATE_PAGE_END is called.\n  //\n  // After bootstrap, we need to listen for this as stateful page\n  // creators e.g. the internal plugin \"component-page-creator\"\n  // calls createPage directly so CREATE_PAGE_END won't get fired.\n  if (bootstrapFinished) {\n    debouncedWritePages()\n  }\n})\n\nemitter.on(`CREATE_PAGE_END`, () => {\n  debouncedWritePages()\n})\nemitter.on(`DELETE_PAGE`, () => {\n  debouncedWritePages()\n})\nemitter.on(`DELETE_PAGE_BY_PATH`, () => {\n  debouncedWritePages()\n})\n"]}